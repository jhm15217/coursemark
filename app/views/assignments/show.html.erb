<%= render "assignments/header" %>

<div class="assignment_details">
  <p>
    <b>Submissions due </b>
    <%= @assignment.submission_due.to_s(:pretty) %>
  </p>

  <p>
    <b>Reviews due </b>
    <%= @assignment.review_due.to_s(:pretty) %>
  </p>
</div>

<% if !@submission.created_at || (Time.zone.now <= @assignment.submission_due) %>
	<%= render 'submission' %>
<% elsif !@submission.created_at && (Time.zone.now > @assignment.submission_due) %>
	<div class="edit_submission">
    <% if Time.zone.now <= @assignment.review_due %>
		  <p>Submissions are no longer being accepted.</p>
    <% else %>
      <p class="grade"><%= @submission.percentage.round %>%</p>
    <% end %>
	</div>
<% else %>
  <div class="edit_submission">
    <% if Time.zone.now <= @assignment.review_due %>
      <p>Your submission was submitted successfully on time.
    <% else %>
      <p class="grade"><%= @submission.percentage.round %>%</p>
    <% end %>
    <a href='http://<%= request.host_with_port %><%= @submission.submission %>' >View Submission</a>
    </p>
  </div>
<% end %>

<div class="clearfix"></div>

<% if (Time.zone.now > @assignment.submission_due) && (Time.zone.now <= @assignment.review_due) %>
  <div id="reviewing_tasks">
    <% @reviewing_tasks.each_with_index do |task, index| %>
      <div class="reviewing_task <%= if task.is_complete? == false then 'highlighted' end %>">
        <% if task.is_complete? %>
          <%= link_to "Edit Review " + (index + 1).to_s, course_assignment_submission_path(@course, @assignment, task.submission) %>
        <% else %>
          <%= link_to "Complete Review " + (index + 1).to_s, course_assignment_submission_path(@course, @assignment, task.submission) %>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>

<div class="clearfix"></div>

<% if @evaluations && (@submission.completed_responses.length > 0) && (Time.zone.now >= @assignment.review_due) %>
<div id="student_evaluation_view">
  <% @evaluations[0].responses.each do |eval| %>
    <div class='submissionQuestionBox clearfix'>
    <h2><%= eval.question.question_text %></h2>
    <div class='possiblePoints'>Possible Points: <%= eval.question.question_weight %></div>
      <% get_evaluations_for_submission_question(@submission, eval.question).each_with_index do |response, index| %>
        <% if response.is_complete? %>
          <div class='submissionBox'>
            <div class='submissionResponsePoints'><%= if !response.scale.nil? then prettifyFloat((eval.question.question_weight / (eval.question.scales.length - 1.0)) * response.scale.value) else '--' end %></div>
            <div class='submissionResponseFrom'>Reviewer <%= index + 1 %></div>
            <div class='submissionPeerReview'><%= response.peer_review %></div>
            <div class='submissionInstructorResponse'>
              <div class='submissionResponseFrom'>Your Reply</div>
              <% if response.student_response != nil then %>
                  <%= response.student_response %>
              <% else %>
                <%= nested_form_for [@course, @assignment, eval.question, response]  do |f| %>
                  <%= f.text_area :student_response, class: 'submissionTextArea fl'  %>
                  <%= f.submit "Reply", class: 'submissionTextAreaReply fr' %>
                <% end %>
              <% end %>
            </div> <!-- End Student Response -->
            <% if response.instructor_response != nil then %>
              <div class='submissionStudentResponse'>
                <div class='submissionResponseFrom'>Instructor's Reply</div>
                <%= response.instructor_response %>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div> <!-- end submissionQuestionBox -->
    <div class="clearfix"></div>
  <% end %>
</div>
<% end %>